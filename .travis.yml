language: generic
sudo: required
dist: trusty

jobs:
  include:
    - stage: lint
      os: osx
      install: ./Tests/Scripts/install_dependencies.sh swiftlint
      script: ${PWD}/swiftlint/swiftlint --strict

    - stage: code coverage
      os: osx
      osx_image: xcode10.1
      env:
        - MONGODB_VERSION=3.6.5
        - LIBMONGOC_VERSION=r1.13
        - INSTALLER=Tests/Scripts/install_dependencies.sh
        - MONGODIR=${PWD}/mongodb-${MONGODB_VERSION}
      install: ./INSTALLER libmongoc; ./INSTALLER mongodb
      before_script:
      script: make coverage
      after_success: bash <(curl -s https://codecov.io/bash)

    - stage: tests
      env:
        global:
          - LIBMONGOC_VERSION=r1.13
          - MONGODB_VERSION=3.6.5
          - INSTALLER=Tests/Scripts/install_dependencies.sh
          - MONGODIR=${PWD}/mongodb-${MONGODB_VERSION}
        matrix:
          - SWIFT_VERSION=4.0 
          - SWIFT_VERSION=4.1
          - SWIFT_VERSION=4.2
      os:
        - osx
        - linux
      osx_image:
        - xcode9.4
        - xcode10.1
      install: ./INSTALLER libmongoc; ./INSTALLER mongodb;  eval "$(curl -sL https://swiftenv.fuller.li/install.sh)"
      before_script: mkdir ${MONGODIR}/data; ${MONGODIR}/bin/mongod --dbpath ${MONGODIR}/data --logpath ${MONGODIR}/mongodb.log --fork
      script:
        - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then make test-pretty; fi
        - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then make test; fi
